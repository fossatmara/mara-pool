# AlertManager configuration for SV2 Pool
# Slack notifications for pool alerts

global:
  # Resolve timeout - how long to wait before declaring an alert resolved
  resolve_timeout: 5m
  # Slack webhook URL - replace with your actual webhook
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# Templates for custom notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing
route:
  # Default receiver
  receiver: 'slack-notifications'
  # Group alerts by alertname and severity
  group_by: ['alertname', 'severity']
  # Wait time before sending initial notification for a group
  group_wait: 30s
  # Wait time before sending notification about new alerts in existing group
  group_interval: 5m
  # Wait time before re-sending a notification
  repeat_interval: 4h

  # Child routes for severity-based routing
  routes:
    # Critical alerts - immediate notification, shorter repeat interval
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 10s
      repeat_interval: 1h

    # Daily recap - special handling
    - match:
        alertname: DailyRecap
      receiver: 'slack-daily-recap'
      group_wait: 1m
      repeat_interval: 24h

# Receivers define notification endpoints
receivers:
  # Default Slack notifications
  - name: 'slack-notifications'
    slack_configs:
      - channel: '#pool-alerts'
        send_resolved: true
        title: '{{ template "slack.pool.title" . }}'
        text: '{{ template "slack.pool.text" . }}'
        color: '{{ template "slack.pool.color" . }}'

  # Critical alerts channel
  - name: 'slack-critical'
    slack_configs:
      - channel: '#pool-alerts-critical'
        send_resolved: true
        title: '{{ template "slack.pool.title" . }}'
        text: '{{ template "slack.pool.text" . }}'
        color: '{{ template "slack.pool.color" . }}'

  # Daily recap channel
  - name: 'slack-daily-recap'
    slack_configs:
      - channel: '#pool-daily-recap'
        send_resolved: false
        title: '{{ template "slack.pool.recap.title" . }}'
        text: '{{ template "slack.pool.recap.text" . }}'
        color: 'good'

# Inhibition rules to prevent alert storms
inhibit_rules:
  # If critical hashrate drop is firing, inhibit warning-level hashrate drop
  - source_match:
      alertname: HashrateCriticalDrop
    target_match:
      alertname: HashrateDropped
    equal: ['user_identity']

  # If critical invalid share spike is firing, inhibit warning-level
  - source_match:
      alertname: InvalidShareSpike
    target_match:
      alertname: HighInvalidShareRate
    equal: ['user_identity']

  # If metrics endpoint is down, inhibit all other alerts (can't trust the data)
  - source_match:
      alertname: MetricsEndpointDown
    target_match_re:
      alertname: '^(Hashrate|Invalid|NoBlocks).*'
